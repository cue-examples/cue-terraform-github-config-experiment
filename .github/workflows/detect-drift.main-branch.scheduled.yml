# Code generated by generate_tool.cue - DO NOT EDIT.
name: Detect drift
"on":
  schedule:
    - cron: 30 7 * * 1-5
  workflow_dispatch: {}
jobs:
  Alert:
    name: Report drift
    needs: []
    if: ${{ failure() }}
    runs-on: ubuntu-20.04
    defaults:
      run:
        working-directory: .
    steps:
      - name: Notify Discord
        if: ${{ always() }}
        run: |-
          curl \
            --no-progress-meter \
            -d content=":x: Infrastructure drift detected: [Workflow]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" \
            -d username="Github Actions" \
            "https://discord.com/api/webhooks/1086214516129398814/${{ secrets.DISCORD_WEBHOOK_TOKEN }}"
      - name: Notify Email
        if: ${{ always() }}
        run: |-
          sudo apt-get install -qq swaks
          swaks \
            -tls \
            --server smtp.gmail.com:587 \
            --auth   LOGIN \
            --auth-user     "${{ secrets.GOOGLE_SMTP_USERNAME }}" \
            --auth-password "${{ secrets.GOOGLE_SMTP_PASSWORD }}" \
            --h-Subject "Infrastructure drift detected" \
            --body      "Infrastructure drift detected: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            --to "cue-terraform-github-config-experiment-controller+notifications@cue.works"
    env:
      CUE_DEBUG_SCRIPTS: ${{ vars.CUE_DEBUG_SCRIPTS }}
env:
  TF_IN_AUTOMATION: yes it is
  TF_INPUT: 0
concurrency:
  group: terraform-state-lock
  cancel-in-progress: false
