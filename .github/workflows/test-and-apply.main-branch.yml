# Code generated by generate_tool.cue - DO NOT EDIT.
name: Test & apply changes
"on":
  push:
    branches:
      - main
jobs:
  Notify-On-Failure:
    name: Notify on apply failure
    needs:
      - Test-Shared-Components
    if: ${{ failure() }}
    runs-on: ubuntu-20.04
    defaults:
      run:
        working-directory: .
    steps:
      - name: Notify Discord
        if: ${{ always() }}
        run: |-
          curl \
            --no-progress-meter \
            -d content=":x: main branch CI failure: [Workflow]($GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID)" \
            -d username="Github Actions" \
            "https://discord.com/api/webhooks/1086214516129398814/${{ secrets.DISCORD_WEBHOOK_TOKEN }}"
      - name: Notify Email
        if: ${{ always() }}
        run: |-
          sudo apt-get install -qq swaks
          swaks \
            -tls \
            --server smtp.gmail.com:587 \
            --auth   LOGIN \
            --auth-user     "${{ secrets.GOOGLE_SMTP_USERNAME }}" \
            --auth-password "${{ secrets.GOOGLE_SMTP_PASSWORD }}" \
            --h-Subject "CI failure on infra repo `main` branch" \
            --body      "Failed CI workflow: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" \
            --to "cue-terraform-github-config-experiment-controller+notifications@cue.works"
    env:
      CUE_DEBUG_SCRIPTS: ${{ vars.CUE_DEBUG_SCRIPTS }}
  Test-Shared-Components:
    name: Test shared components
    runs-on: ubuntu-20.04
    defaults:
      run:
        working-directory: .
    steps:
      - name: Check out code
        uses: actions/checkout@v3
        if: ${{ success() }}
      - name: Setup CUE
        uses: cue-lang/setup-cue@0be332bb74c8a2f07821389447ba3163e2da3bfb
        with:
          version: v0.6.0-alpha.1
        if: ${{ success() }}
      - name: Test that all generated files match their CUE sources
        run: make generate check_clean_working_tree
      - name: Test the unified config
        run: make test-config
    env:
      CUE_DEBUG_SCRIPTS: ${{ vars.CUE_DEBUG_SCRIPTS }}
env:
  TF_IN_AUTOMATION: yes it is
  TF_INPUT: 0
concurrency:
  group: terraform-state-lock
  cancel-in-progress: false
